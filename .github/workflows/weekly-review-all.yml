name: "Weekly AI Review ‚Äî Active Repos Only"

on:
  schedule:
    - cron: '0 6 * * 0'  # Sunday 6:00 UTC
  workflow_dispatch:
    inputs:
      single_repo:
        description: "Review only this repo (leave blank for active repos)"
        required: false
        default: ""
      activity_days:
        description: "Consider repos active if pushed within N days (default: 7)"
        required: false
        default: "7"

jobs:
  discover:
    name: "Discover active repositories"
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.list.outputs.repos }}
    steps:
      - name: Checkout hub
        uses: actions/checkout@v4

      - name: Find active repos
        id: list
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          OWNER=$(grep 'github_owner' config.yml | awk '{print $2}' | tr -d '"')
          ACTIVITY_DAYS="${{ github.event.inputs.activity_days || '7' }}"

          # Read config
          EXCLUDE=$(python3 -c "
          import yaml, json
          with open('config.yml') as f:
              cfg = yaml.safe_load(f)
          print(json.dumps(cfg.get('exclude_repos', [])))
          ")

          INCLUDE_ONLY=$(python3 -c "
          import yaml, json
          with open('config.yml') as f:
              cfg = yaml.safe_load(f)
          print(json.dumps(cfg.get('include_only', [])))
          ")

          # Fetch all repos with pushed_at dates
          REPOS_RAW=$(gh api --paginate "/users/${OWNER}/repos?per_page=100&type=owner" \
            --jq '[.[] | select(.fork == false and .archived == false) | {name: .name, pushed_at: .pushed_at}]')

          # Filter: only repos with activity in the last N days
          FILTERED=$(python3 -c "
          import json, sys
          from datetime import datetime, timedelta, timezone

          repos_raw = json.loads('$REPOS_RAW')
          exclude = json.loads('$EXCLUDE')
          include_only = json.loads('$INCLUDE_ONLY')
          single = '${{ github.event.inputs.single_repo }}'.strip()
          activity_days = int('$ACTIVITY_DAYS')

          cutoff = datetime.now(timezone.utc) - timedelta(days=activity_days)
          active = []
          skipped = []

          for r in repos_raw:
              name = r['name']
              pushed = datetime.fromisoformat(r['pushed_at'].replace('Z', '+00:00'))

              # Apply include/exclude filters
              if single:
                  if name != single:
                      continue
              elif include_only:
                  if name not in include_only:
                      continue
              else:
                  if name in exclude:
                      continue

              # Check activity
              if pushed >= cutoff:
                  active.append(name)
              else:
                  skipped.append(f'{name} (last push: {r[\"pushed_at\"][:10]})')

          print(json.dumps(active))

          # Print skipped for logging
          import sys as _sys
          for s in skipped:
              print(f'üí§ Skipped inactive: {s}', file=_sys.stderr)
          ")

          echo "repos=$FILTERED" >> $GITHUB_OUTPUT

          # Summary
          ACTIVE_COUNT=$(echo "$FILTERED" | python3 -c 'import json,sys; print(len(json.load(sys.stdin)))')
          echo "## üìã Repository Discovery" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Activity window:** last ${ACTIVITY_DAYS} days" >> $GITHUB_STEP_SUMMARY
          echo "**Active repos:** ${ACTIVE_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Will review:** ${FILTERED}" >> $GITHUB_STEP_SUMMARY

  review:
    name: "Review ${{ matrix.repo }}"
    needs: discover
    if: needs.discover.outputs.repos != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        repo: ${{ fromJson(needs.discover.outputs.repos) }}
    permissions:
      contents: read

    steps:
      - name: Checkout hub (for scripts)
        uses: actions/checkout@v4
        with:
          path: hub

      - name: Clone target repo
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          OWNER=$(grep 'github_owner' hub/config.yml | awk '{print $2}' | tr -d '"')
          git clone --depth 1 "https://x-access-token:${GH_TOKEN}@github.com/${OWNER}/${{ matrix.repo }}.git" target

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install google-genai
        run: pip install -q google-genai pyyaml

      - name: Run AI review
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          MODEL=$(python3 -c "
          import yaml
          with open('hub/config.yml') as f:
              print(yaml.safe_load(f).get('gemini', {}).get('weekly_model', 'gemini-2.5-flash'))
          ")

          python hub/scripts/ai-review.py \
            --mode full \
            --project-dir target \
            --model "$MODEL" \
            --output review_report.md

          echo "‚úÖ Review completed for ${{ matrix.repo }}" >> $GITHUB_STEP_SUMMARY

      - name: Create issue in target repo
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          OWNER=$(grep 'github_owner' hub/config.yml | awk '{print $2}' | tr -d '"')
          DATE=$(date +%Y-%m-%d)
          REPORT=$(cat review_report.md)

          # Close previous automated issues
          gh issue list \
            --repo "${OWNER}/${{ matrix.repo }}" \
            --label "ai-code-review,automated" \
            --state open \
            --json number \
            --jq '.[].number' | while read num; do
              gh issue close "$num" --repo "${OWNER}/${{ matrix.repo }}" 2>/dev/null || true
            done

          # Create new issue
          BODY=$(cat <<ISSUE_EOF
          ${REPORT}

          ---
          *ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ [code-review-hub](https://github.com/${OWNER}/code-review-hub) ¬∑ Gemini AI ¬∑ ${DATE}*
          ISSUE_EOF
          )

          gh issue create \
            --repo "${OWNER}/${{ matrix.repo }}" \
            --title "[AI Review] –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç ‚Äî ${DATE}" \
            --body "$BODY" \
            --label "ai-code-review,automated" 2>/dev/null || \
          gh issue create \
            --repo "${OWNER}/${{ matrix.repo }}" \
            --title "[AI Review] –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç ‚Äî ${DATE}" \
            --body "$BODY"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: review-${{ matrix.repo }}
          path: review_report.md
          retention-days: 30

  notify:
    name: "Send notifications"
    needs: [discover, review]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout hub
        uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Build summary & send webhook
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          OWNER=$(grep 'github_owner' config.yml | awk '{print $2}' | tr -d '"')
          DATE=$(date +%Y-%m-%d)
          REPOS='${{ needs.discover.outputs.repos }}'

          SUMMARY="# üìä Weekly AI Review Summary ‚Äî ${DATE}\n\n"
          SUMMARY+="**Active repos reviewed:** $(echo "$REPOS" | python3 -c 'import json,sys; print(len(json.load(sys.stdin)))')\n\n"

          for dir in reports/review-*/; do
            REPO_NAME=$(basename "$dir" | sed 's/review-//')
            if [ -f "$dir/review_report.md" ]; then
              SCORE=$(grep -oP 'Health Score:\s*\K[0-9.]+' "$dir/review_report.md" 2>/dev/null || echo "N/A")
              SUMMARY+="- **${REPO_NAME}**: Health ${SCORE}/10\n"
            fi
          done

          echo -e "$SUMMARY" >> $GITHUB_STEP_SUMMARY

          # Send webhook if configured
          if [ -n "$WEBHOOK_URL" ]; then
            PAYLOAD=$(jq -n \
              --arg event "weekly_review_summary" \
              --arg date "$DATE" \
              --arg owner "$OWNER" \
              --argjson repos "$REPOS" \
              --arg summary "$(echo -e "$SUMMARY")" \
              '{event:$event, date:$date, owner:$owner, repos:$repos, summary:$summary}')

            curl -sf -X POST "$WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              --max-time 30 || echo "‚ö†Ô∏è Webhook delivery failed"
          fi
