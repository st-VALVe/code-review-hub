# managed-by: code-review-hub v2
name: Code Quality Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -q ruff mypy pytest pip-audit 2>/dev/null || true
          if [ -f requirements.txt ]; then pip install -q -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -q -e '.[dev]' 2>/dev/null || pip install -q -e . 2>/dev/null || true; fi
          mkdir -p qr

      # â”€â”€ Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Ruff lint
        id: lint
        run: |
          ruff check . > qr/lint.txt 2>&1; RC=$?
          cat qr/lint.txt
          echo "status=$RC" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Ruff format
        id: format
        run: |
          ruff format --check . > qr/format.txt 2>&1; RC=$?
          cat qr/format.txt
          echo "status=$RC" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: MyPy
        id: typecheck
        run: |
          mypy . --ignore-missing-imports > qr/typecheck.txt 2>&1; RC=$?
          cat qr/typecheck.txt
          echo "status=$RC" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Tests
        id: test
        run: |
          if find . -maxdepth 3 -name 'test_*.py' -o -name '*_test.py' | head -1 | grep -q .; then
            python -m pytest -v > qr/test.txt 2>&1; RC=$?
            cat qr/test.txt
            echo "status=$RC" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No test files found" | tee qr/test.txt
            echo "status=skip" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Security Audit
        id: security
        run: |
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt > qr/security.txt 2>&1; RC=$?
            cat qr/security.txt
            echo "status=$RC" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No requirements.txt" | tee qr/security.txt
            echo "status=skip" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # â”€â”€ Report: PR Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const read = f => { try { return fs.readFileSync(`qr/${f}`, 'utf8').trim(); } catch { return 'N/A'; } };
            const icon = s => s === 'skip' ? 'â­ï¸' : s === '0' ? 'âœ…' : 'âŒ';

            const ls = '${{ steps.lint.outputs.status }}';
            const fs2 = '${{ steps.format.outputs.status }}';
            const ts = '${{ steps.typecheck.outputs.status }}';
            const tt = '${{ steps.test.outputs.status }}';
            const ss = '${{ steps.security.outputs.status }}';

            const body = [
              '## ğŸ” Code Quality Report (Python)', '',
              '| Check | Status |', '|-------|--------|',
              `| Ruff lint | ${icon(ls)} |`,
              `| Ruff format | ${icon(fs2)} |`,
              `| MyPy | ${icon(ts)} |`,
              `| Tests | ${icon(tt)} |`,
              `| Security | ${icon(ss)} |`, '',
              '<details><summary>ğŸ“‹ Ruff lint</summary>', '',
              '```', read('lint.txt').substring(0, 3000), '```', '</details>', '',
              '<details><summary>ğŸ“‹ Ruff format</summary>', '',
              '```', read('format.txt').substring(0, 3000), '```', '</details>', '',
              '<details><summary>ğŸ“‹ MyPy</summary>', '',
              '```', read('typecheck.txt').substring(0, 3000), '```', '</details>', '',
              '<details><summary>ğŸ“‹ Tests</summary>', '',
              '```', read('test.txt').substring(0, 3000), '```', '</details>', '',
              '<details><summary>ğŸ“‹ Security</summary>', '',
              '```', read('security.txt').substring(0, 3000), '```', '</details>', '',
              '---',
              `*ğŸ¤– [code-review-hub](https://github.com/${context.repo.owner}/code-review-hub) Â· \`${context.sha.substring(0,7)}\`*`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body?.includes('Code Quality Report') && c.body?.includes('code-review-hub'));
            if (existing) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });
            }

      # â”€â”€ Report: Webhook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Send webhook
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          [ -z "$WEBHOOK_URL" ] && exit 0
          jq -n \
            --arg event "code_quality" \
            --arg repo "${{ github.repository }}" \
            --arg ref "${{ github.ref }}" \
            --arg sha "${{ github.sha }}" \
            --arg lint "${{ steps.lint.outputs.status }}" \
            --arg format "${{ steps.format.outputs.status }}" \
            --arg typecheck "${{ steps.typecheck.outputs.status }}" \
            --arg test "${{ steps.test.outputs.status }}" \
            --arg security "${{ steps.security.outputs.status }}" \
            '{event:$event,repo:$repo,ref:$ref,sha:$sha,
              results:{lint:$lint,format:$format,typecheck:$typecheck,
              test:$test,security:$security}}' |
          curl -sf -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" -d @- --max-time 30 || echo "âš ï¸ Webhook failed"

      # â”€â”€ Report: Issue on critical problems â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: Create issue (critical on main)
        if: |
          always() && github.event_name == 'push' &&
          (steps.security.outputs.status != '0' && steps.security.outputs.status != 'skip' ||
           steps.test.outputs.status     != '0' && steps.test.outputs.status     != 'skip')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE=$(date +%Y-%m-%d)
          ico() { [ "$1" = "0" ] && echo "âœ…" || echo "âŒ"; }

          BODY="## ğŸš¨ Code Quality Issues Detected (Python)

          **Branch:** \`${{ github.ref_name }}\`
          **Commit:** [\`${{ github.sha }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

          | Check | Status |
          |-------|--------|
          | Ruff lint | $(ico ${{ steps.lint.outputs.status }}) |
          | Ruff format | $(ico ${{ steps.format.outputs.status }}) |
          | MyPy | $(ico ${{ steps.typecheck.outputs.status }}) |
          | Tests | $(ico ${{ steps.test.outputs.status }}) |
          | Security | $(ico ${{ steps.security.outputs.status }}) |

          [View full run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *ğŸ¤– [code-review-hub](https://github.com/${{ github.repository_owner }}/code-review-hub)*"

          gh issue list --label "code-quality,automated" --state open --json number --jq '.[].number' 2>/dev/null | while read num; do
            gh issue close "$num" 2>/dev/null || true
          done

          echo "$BODY" | gh issue create \
            --title "[Code Quality] ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ â€” ${DATE}" \
            --body-file - \
            --label "code-quality,automated" 2>/dev/null || \
          echo "$BODY" | gh issue create \
            --title "[Code Quality] ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ â€” ${DATE}" \
            --body-file -
